<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social ETL Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Social ETL Scheduler</h2>
        <div>
            Status: <span id="api-status" class="status-offline">CHECKING...</span>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Event Extraction Logs</span>
            <button id="sync-btn" class="btn btn-primary btn-sm" onclick="triggerSync()">
                Sync Now
            </button>
        </div>
        <div class="card-body p-0">
            <div id="log-container">
                <div class="log-entry">> Initializing Social ETL Dashboard...</div>
                <div class="log-entry">> Waiting for logs...</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Found Events</div>
        <div class="card-body">
            <p class="text-muted small">Recent events extracted from email will appear here.</p>
            <ul id="event-list" class="list-group list-group-flush">
                <!-- Events will be populated here -->
            </ul>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function triggerSync() {
        const btn = document.getElementById('sync-btn');
        btn.disabled = true;
        btn.innerText = "Syncing...";
        
        // Optimistic log update
        addLog("Manual Sync Triggered...");

        fetch('/api/trigger', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                addLog("Response: " + data.message);
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "Sync Now";
                }, 2000);
            })
            .catch(err => {
                addLog("Error triggering sync: " + err);
                btn.disabled = false;
                btn.innerText = "Sync Now";
            });
    }

    function addLog(message) {
        const container = document.getElementById('log-container');
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerText = "> " + message;
        container.prepend(div); // Add to top
    }

    function fetchLogs() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('log-container');
                
                // Update Log View
                // For efficiency in this demo, we just rebuild if needed or append. 
                // Let's clear and rebuild for simplicity to match backend state exactly.
                container.innerHTML = ''; 
                data.logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerText = "> " + log;
                    container.appendChild(div);
                });

                // Update Status
                const statusEl = document.getElementById('api-status');
                if (data.status === "RUNNING") {
                    statusEl.innerText = "RUNNING";
                    statusEl.className = "status-online";
                    document.getElementById('sync-btn').disabled = true;
                    document.getElementById('sync-btn').innerText = "Running...";
                } else {
                    statusEl.innerText = "IDLE";
                    statusEl.className = "status-online"; 
                    if(document.getElementById('sync-btn').innerText === "Running...") {
                         document.getElementById('sync-btn').disabled = false;
                         document.getElementById('sync-btn').innerText = "Sync Now";
                    }
                }
            })
            .catch(() => {
                 const statusEl = document.getElementById('api-status');
                 statusEl.innerText = "OFFLINE";
                 statusEl.className = "status-offline";
            });
        
        setTimeout(fetchLogs, 2000);
    }

    // Start polling
    fetchLogs();
</script>

</body>
</html>
