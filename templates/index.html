<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social ETL | Family Log-Parser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="scene-container">
        <!-- Background Compass Dial -->
        <div class="compass-dial"></div>
        
        <!-- Interactive Character -->
        <div class="orb-character" onclick="openTerminal()" title="Click to access Terminal Log"></div>
        
        <!-- Holographic Status -->
        <div class="hologram-status">
            <div class="status-text" id="dashboard-status">SYSTEM IDLE</div>
            <div style="font-size: 0.8rem; margin-top: 5px; color: #888;">NEXT RUN: <span id="next-run">14:00</span></div>
        </div>
    </div>

    <!-- Terminal Overlay -->
    <div class="terminal-overlay" id="terminal">
        <div class="terminal-header">
            <span>> SOCIAL_ETL_DAEMON_V2.0 [ORB_CORE]</span>
            <button class="close-btn" onclick="closeTerminal()">[DISCONNECT]</button>
        </div>
        
        <div class="terminal-grid">
            <!-- Left Column: Raw Logs -->
            <div class="col" id="raw-log">
                <div class="col-title">RAW_PACKET_STREAM</div>
                <!-- JS will inject logs here -->
                <div class="log-entry">> CONNECTION ESTABLISHED...</div>
                <div class="log-entry">> ORB ONLINE. LISTENING...</div>
            </div>

            <!-- Right Column: Structured Data -->
            <div class="col" id="structured-data">
                <div class="col-title">STRUCTURED_OBJECT_BUFFER</div>
                <!-- JS will inject JSON here -->
                <div class="log-entry" style="color: #666;">[WAITING FOR PAYLOAD]</div>
            </div>
        </div>

        <div class="action-bar">
            <span>> SYSTEM_STATUS: <span style="color: var(--neon-blue);">ONLINE</span></span>
            <button class="force-run-btn" onclick="triggerETL()">[INITIATE_FORCE_RUN]</button>
        </div>
    </div>

    <script>
        function openTerminal() {
            document.getElementById('terminal').style.display = 'flex';
            fetchLogs();
        }

        function closeTerminal() {
            document.getElementById('terminal').style.display = 'none';
        }

        function triggerETL() {
            const btn = document.querySelector('.force-run-btn');
            const originalText = btn.innerText;
            btn.innerText = "[EXECUTING...]";
            
            fetch('/api/trigger', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    btn.innerText = originalText;
                })
                .catch(err => {
                    alert("Error: " + err);
                    btn.innerText = originalText;
                });
        }

        function fetchLogs() {
            // Poll for logs if terminal is open
            if(document.getElementById('terminal').style.display === 'none') return;
            
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const logContainer = document.getElementById('raw-log');
                    const currentLogs = logContainer.innerHTML;
                    
                    // Simple rebuild - optimize in V3 if needed
                    let newHtml = '<div class="col-title">RAW_PACKET_STREAM</div>';
                    data.logs.forEach(log => {
                        newHtml += `<div class="log-entry">> ${log}</div>`;
                    });
                    
                    if (logContainer.innerHTML !== newHtml) {
                         logContainer.innerHTML = newHtml;
                    }

                    // Update Dashboard Status
                    const statusEl = document.getElementById('dashboard-status');
                    statusEl.innerText = data.status;
                    
                    if (data.status === "RUNNING") {
                        statusEl.style.color = "var(--neon-green)";
                        statusEl.style.textShadow = "0 0 10px var(--neon-green)";
                    } else {
                        statusEl.style.color = "var(--neon-blue)";
                        statusEl.style.textShadow = "0 0 10px var(--neon-blue)";
                    }
                });
            
            setTimeout(fetchLogs, 2000);
        }
    </script>
</body>
</html>
