<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Social ETL // Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:ital,wght@0,600;1,600&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. VIBE LAB ENVIRONMENT (Background)
           ========================================= */
        body {
            /* THE BURNISHED DAWN GRADIENT */
            /* Top Left: Antique Brass (#B58B00) - Richer, darker gold */
            /* Bottom Right: Deep Azure (#0077BE) - darker, oceanic version of Orb Blue */
            /* Opacity set to 12% for a subtle, heavy wash */
            background: linear-gradient(135deg, rgba(181, 139, 0, 0.12) 0%, rgba(0, 119, 190, 0.12) 100%);
            
            background-attachment: fixed;

            color: #111;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 60px; /* Matched to Vibe Station spacing */
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;

            /* PRO FINISH: Crisp typography */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #canvas-orb {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind everything */
            opacity: 0.8;
            pointer-events: none;
        }

        /* =========================================
           2. LAYOUT ARCHITECTURE
           ========================================= */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 60px; /* Increased for Vibe Station spacing */
            
            /* CHANGED: 'start' -> 'stretch' */
            /* CRITICAL: Forces the Left Column to match the Right Column's height */
            align-items: stretch;
        }

        @media (max-width: 1000px) {
            .dashboard-container { grid-template-columns: 1fr; gap: 24px; padding: 10px; }
        }

        /* LEFT COLUMN: The "Manifesto" Sidebar */
        .sidebar {
            /* REMOVED: position: sticky, top */
            display: flex;
            flex-direction: column;
            gap: 2rem;
            height: auto;
        }

        .brand-title {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 600;
            font-style: italic;
            line-height: 0.95;
            letter-spacing: -0.03em;
            margin: 0;
            color: #000;
        }

        .unit-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #666;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        /* RIGHT COLUMN: The Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .vibe-card {
            background: #FFFFFF;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
        }

        .card-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #999;
            margin-bottom: 1.5rem;
            display: block;
        }

        /* =========================================
           3. TERMINAL & LISTS
           ========================================= */
        .terminal-body {
            background: #FAFAFA;
            border: 1px solid #EEE;
            border-radius: 16px;
            padding: 1.5rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: #444;
        }

        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #F0F0F0; padding-bottom: 4px; }

        .event-list { list-style: none; padding: 0; margin: 0; }
        .event-item {
            padding: 1rem;
            border-bottom: 1px solid #EEE;
            transition: background 0.2s;
        }
        .event-item:last-child { border-bottom: none; }
        .event-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .event-title { font-weight: 600; color: #000; }
        .event-tag { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: #00BFFF; }
        .event-time { font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; }
        .event-desc { font-size: 0.85rem; color: #666; line-height: 1.4; }

        /* PENDING DRAWER */
        .pending-drawer {
            margin-top: 2rem;
        }
        .pending-card {
            background: #FFF;
            border: 1px solid #EEE;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pending-info h4 { margin: 0; font-size: 0.95rem; }
        .pending-meta { font-size: 0.75rem; color: #999; margin-top: 4px; }
        .pending-actions { display: flex; gap: 8px; }

        /* =========================================
           4. BUTTONS & ACTIONS
           ========================================= */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #111; color: #FFF; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-outline { background: transparent; border: 1px solid #DDD; color: #666; }
        .btn-outline:hover { border-color: #000; color: #000; }
        .btn-approve { background: #00BFFF; color: #FFF; }
        .btn-reject { background: #FFF; border: 1px solid #FEE; color: #FF0055; }

        .status-indicator {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 1rem;
            display: block;
        }
        .status-running { color: #00BFFF; font-weight: bold; }

        nav { display: flex; gap: 1rem; margin-top: 1rem; }
        nav a { font-size: 0.7rem; text-transform: uppercase; color: #999; text-decoration: none; letter-spacing: 0.1em; }
        nav a:hover { color: #000; }
    </style>
</head>
<body>

    <div id="canvas-orb"></div>

    <div class="dashboard-container">
        
        <div class="sidebar">
            <div>
                <img src="/static/images/hero-branding.png" alt="Logistics Branding" style="width: 130%; height: auto; border-radius: 12px; margin-bottom: 2.5rem; margin-left: -15%; display: block; opacity: 0.9;">
                <h1 class="brand-title">The<br>Social ETL</h1>
                <p style="font-size:0.9rem; color:#666; margin-top:1.5rem; line-height:1.6;">
                    Live operational terminal for identification and extraction.
                </p>
                <nav>
                    <a href="/">Settings</a>
                    <a href="/debug">Debug</a>
                </nav>
            </div>

            <div class="vibe-card">
                <span class="card-label">Management</span>
                <span id="api-status-label" class="status-indicator">STATUS: <span id="api-status">INITIALIZING</span></span>
                <button id="sync-btn" class="btn btn-primary" onclick="triggerSync()">INITIATE SYNC</button>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="toggleLogistics()">LOGISTICS MODULE</button>
            </div>
        </div>

        <div class="cards-grid">
            
            <div class="vibe-card" style="grid-column: 1 / -1; display:none;" id="logistics-panel">
                <span class="card-label">Pending Approval (Logistics)</span>
                <div id="pending-list">
                    <p style="font-size:0.85rem; color:#999;">Scanning for fragment approval...</p>
                </div>
            </div>

            <div class="vibe-card">
                <span class="card-label">Recent Findings</span>
                <div class="event-body">
                    <ul id="event-list" class="event-list">
                        <li style="color:#999; font-size:0.85rem;">Listening for data events...</li>
                    </ul>
                </div>
            </div>

            <div class="vibe-card">
                <span class="card-label">Activity Logs</span>
                <div id="log-container" class="terminal-body">
                    <div class="log-entry">> Initializing Vibe Terminal...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Dashboard Logic ---
        function toggleLogistics() {
            const panel = document.getElementById('logistics-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                fetchPendingEvents();
            } else {
                panel.style.display = 'none';
            }
        }

        function fetchPendingEvents() {
            const list = document.getElementById('pending-list');
            fetch('/api/events/pending')
                .then(r => r.json())
                .then(events => {
                    list.innerHTML = '';
                    if (events.length === 0) {
                        list.innerHTML = '<p style="font-size:0.85rem; color:#999;">No pending events awaiting approval.</p>';
                        return;
                    }
                    events.forEach(event => {
                        const title = event.event_title || event.summary || "Unknown Event";
                        const rawStart = event.start ? event.start.dateTime : (event.start_time || null);
                        let dateStr = "TBD";
                        if (rawStart) {
                            const d = new Date(rawStart);
                            dateStr = !isNaN(d) ? d.toLocaleString() : rawStart;
                        }
                        const card = document.createElement('div');
                        card.className = 'pending-card';
                        card.innerHTML = `
                            <div class="pending-info">
                                <h4>${title}</h4>
                                <div class="pending-meta">
                                    ${dateStr} // ${event.source || 'N/A'}
                                    ${event.source_url ? `// <a href="${event.source_url}" target="_blank" style="color: #00BFFF; text-decoration: none; font-weight: bold;">[ SOURCE ]</a>` : ''}
                                </div>
                            </div>
                            <div class="pending-actions">
                                <button class="btn btn-approve btn-sm" onclick="approveEvent('${event.id}')">APPROVE</button>
                                <button class="btn btn-reject btn-sm" onclick="rejectEvent('${event.id}')">REJECT</button>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                })
                .catch(err => console.error("Pending Fetch Error:", err));
        }

        function approveEvent(id) {
            addLog(`Approving Event ${id}...`);
            fetch('/api/events/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            })
            .then(r => r.json())
            .then(data => {
                addLog(data.message);
                fetchPendingEvents();
            })
            .catch(err => addLog("Approval Error: " + err));
        }

        function rejectEvent(id) {
            if(!confirm("Reject this event?")) return;
            addLog(`Rejecting Event ${id}...`);
            fetch('/api/events/reject', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            })
            .then(r => r.json())
            .then(data => {
                addLog(data.message);
                fetchPendingEvents();
            })
            .catch(err => addLog("Rejection Error: " + err));
        }

        function triggerSync() {
            const btn = document.getElementById('sync-btn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "SYNCING...";
            addLog("Manual Sync Initiated...");

            fetch('/api/trigger', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    addLog("Sync started: " + data.message);
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = originalText;
                    }, 2000);
                })
                .catch(err => {
                    addLog("Error: " + err);
                    btn.disabled = false;
                    btn.innerText = originalText;
                });
        }

        function addLog(message) {
            const container = document.getElementById('log-container');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = "> " + message;
            container.prepend(div);
        }

        function fetchLogs() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('log-container');
                    container.innerHTML = '';
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach((log) => {
                            const div = document.createElement('div');
                            div.className = 'log-entry';
                            div.innerHTML = "> " + log;
                            container.appendChild(div);
                        });
                    } else {
                        container.innerHTML = '<div class="log-entry">> No system logs.</div>';
                    }

                    const statusEl = document.getElementById('api-status');
                    statusEl.innerText = data.status;
                    statusEl.className = data.status === "RUNNING" ? "status-running" : "";
                    
                    document.getElementById('sync-btn').disabled = data.status === "RUNNING";
                    if (data.status === "RUNNING") {
                        document.getElementById('sync-btn').innerText = "RUNNING...";
                    } else {
                        document.getElementById('sync-btn').innerText = "INITIATE SYNC";
                    }

                    const eventList = document.getElementById('event-list');
                    eventList.innerHTML = '';
                    if (data.events && data.events.length > 0) {
                        data.events.forEach(event => {
                            const li = document.createElement('li');
                            li.className = 'event-item';
                            const subjects = event.subjects ? event.subjects.join(', ') : 'GENERAL';
                            const timeStr = event.start_time ? new Date(event.start_time).toLocaleString() : 'TBD';
                            li.innerHTML = `
                                <div class="event-header">
                                    <span class="event-title">${event.event_title}</span>
                                    <span class="event-tag">${subjects}</span>
                                </div>
                                <div class="event-time">${timeStr}</div>
                                <div class="event-desc">${event.description || ''}</div>
                            `;
                            eventList.appendChild(li);
                        });
                    } else {
                        eventList.innerHTML = '<li style="color:#999; font-size:0.85rem;">> No operational data detected.</li>';
                    }
                    if (document.getElementById('logistics-panel').style.display !== 'none') {
                        fetchPendingEvents();
                    }
                })
                .catch(() => {
                    document.getElementById('api-status').innerText = "OFFLINE";
                    document.getElementById('api-status').style.color = "#FF0055";
                });
            setTimeout(fetchLogs, 5000);
        }

        fetchLogs();
    </script>

    <!-- 3D Visualization Logic (ORB) -->
    <script>
        function initSnowmanOrb(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(24, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.z = 13;
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, physicallyCorrectLights: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            const resize = () => {
                renderer.setSize(container.clientWidth, container.clientHeight);
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
            };
            window.addEventListener('resize', resize);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const point1 = new THREE.PointLight(0xffeedd, 1); point1.position.set(5, 5, 5); scene.add(point1);
            const point2 = new THREE.PointLight(0xddddff, 0.5); point2.position.set(-5, 5, 5); scene.add(point2);
            
            const group = new THREE.Group();
            scene.add(group);

            const pNoise = (x, y, z) => Math.sin(x * 3.2 + Math.cos(y * 2.1)) * Math.cos(z * 1.8 + Math.sin(x * 1.5));
            const bodyGeo = new THREE.SphereGeometry(1.5, 64, 64);
            const posAttribute = bodyGeo.attributes.position;
            const vertex = new THREE.Vector3();
            for (let i = 0; i < posAttribute.count; i++) {
                vertex.fromBufferAttribute(posAttribute, i);
                const n = pNoise(vertex.x, vertex.y, vertex.z);
                vertex.multiplyScalar(1.0 + (n * 0.05));
                posAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
            }
            bodyGeo.computeVertexNormals();
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 1.0 });
            group.add(new THREE.Mesh(bodyGeo, bodyMat));

            let mX = 0, mY = 0;
            document.addEventListener('mousemove', (e) => { mX = (e.clientX / window.innerWidth) * 2 - 1; mY = -(e.clientY / window.innerHeight) * 2 + 1; });

            const animate = () => {
                requestAnimationFrame(animate);
                group.position.y = Math.sin(Date.now() * 0.001) * 0.1;
                group.rotation.y += (mX * 0.5 - group.rotation.y) * 0.05;
                group.rotation.x += (-mY * 0.5 - group.rotation.x) * 0.05;
                renderer.render(scene, camera);
            };
            animate();
        }
        window.addEventListener('load', () => initSnowmanOrb('canvas-orb'));
    </script>
</body>
</html>
