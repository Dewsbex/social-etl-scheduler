<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Social ETL Scheduler</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:ital,wght@0,400;1,400&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. THE CHASSIS (Container & Background)
           ========================================= */
        body {
            background-color: #0b0b0b; /* The Void */
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .settings-card {
            background-color: #141414; /* Chassis Grey */
            border: 1px solid #333;
            width: 95%; 
            max-width: 600px;
            padding: 2rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            position: relative;
            border-radius: 2px;
        }

        /* =========================================
           2. TYPOGRAPHY & ID
           ========================================= */
        .settings-header {
            border-bottom: 1px solid #333;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .settings-title {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 2.2rem;
            color: #fff;
            margin: 0;
            line-height: 1;
        }

        .serial-id {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: #fff;
            opacity: 0.3;
            letter-spacing: 0.2em;
            border: 1px solid #444;
            padding: 4px 8px;
            text-transform: uppercase;
        }

        .nav-link {
            position: absolute;
            top: -30px;
            left: 0;
            color: #666;
            text-decoration: none;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .nav-link:hover { color: #00FFFF; }

        /* =========================================
           3. DATA SLOTS (Inputs)
           ========================================= */
        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .tag-display-area {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .input-slot {
            width: 100%;
            background-color: #0b0b0b; /* Recessed */
            border: 1px solid #333;
            border-left: 3px solid #333; /* The Status Bar */
            color: #fff;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            box-sizing: border-box;
            display: flex;
            gap: 10px;
        }

        .input-slot:focus-within {
            outline: none;
            background-color: #111;
            border-color: #555;
            border-left-color: #00FFFF;
        }

        .input-slot input {
            background: transparent;
            border: none;
            color: #fff;
            flex: 1;
            outline: none;
            font-family: inherit;
        }

        .input-slot button {
            background: none;
            border: 1px solid #444;
            color: #666;
            font-size: 0.6rem;
            padding: 2px 8px;
            cursor: pointer;
        }

        .input-slot button:hover { border-color: #00FFFF; color: #00FFFF; }

        .category-tag {
            background: rgba(0, 255, 255, 0.05);
            color: #00FFFF;
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 2px 8px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .category-tag.danger {
            color: #ff0055;
            border-color: rgba(255, 0, 85, 0.3);
            background: rgba(255, 0, 85, 0.05);
        }

        /* =========================================
           4. THE STACKED TRAY (Mapper)
           ========================================= */
        .mapper-section {
            margin-top: 2rem;
            border-top: 1px solid #333;
            padding-top: 1.5rem;
        }

        .mapper-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 1rem;
            display: block;
        }

        .chip-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            min-height: 60px;
            padding: 1rem;
            background: #0e0e0e;
            border: 1px dashed #333;
        }

        .chip {
            background: #222;
            border: 1px solid #444;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chip.ghost {
            opacity: 0.4;
            border-color: #00FFFF;
            background: #0b0b0b;
        }

        .chip.ghost::after {
            content: ' ✓';
            color: #00FFFF;
            font-weight: bold;
        }

        .chip.dragging { opacity: 0.2; }

        .delete-btn {
            color: #ff0055;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            line-height: 1;
        }

        .bucket-drawer {
            background: #111;
            border: 1px solid #333;
            margin-bottom: 0.5rem;
            padding: 1rem;
            transition: border-color 0.2s;
        }

        .bucket-drawer.ready-to-drop {
            border-color: #00FFFF;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
        }

        .bucket-drawer.drag-over {
            border-color: #00FFFF;
            background: rgba(0, 255, 255, 0.05);
        }

        .bucket-drawer h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #888;
        }

        .bucket-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .assigned-chip {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 2px 8px;
            font-size: 0.7rem;
            color: #888;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-id { color: #ff0055; cursor: pointer; }

        /* =========================================
           5. SYNTH KEY (Save Button) & SYNC
           ========================================= */
        .bottom-actions {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .save-btn {
            width: 100%;
            background-color: #e0e0e0;
            color: #000;
            border: none;
            padding: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .save-btn:active {
            transform: translateY(2px);
            background-color: #ccc;
        }

        .sync-pulse {
            text-align: center;
            font-size: 0.65rem;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            text-decoration: underline;
        }

        .sync-pulse:hover { color: #00FFFF; }

        #saveStatus {
            text-align: center;
            font-size: 0.7rem;
            color: #00ff9d;
            height: 15px;
        }
    </style>
</head>
<body>

<div class="settings-card">
    <a href="/dashboard" class="nav-link">Terminal</a>
    
    <header class="settings-header">
        <h1 class="settings-title">Slate Configuration</h1>
        <div class="serial-id">UNIT: ETL-01</div>
    </header>

    <form id="settingsForm">
        <!-- Input Slots -->
        <div class="input-group">
            <label>Master Labels</label>
            <div id="childrenTags" class="tag-display-area"></div>
            <div class="input-slot">
                <input type="text" id="childrenInput" placeholder="Add Subject...">
                <button type="button" onclick="addTag('children')">ADD</button>
            </div>
        </div>

        <div class="input-group">
            <label>Year Groups</label>
            <div id="year_groupsTags" class="tag-display-area"></div>
            <div class="input-slot">
                <input type="text" id="year_groupsInput" placeholder="Add Year...">
                <button type="button" onclick="addTag('year_groups')">ADD</button>
            </div>
        </div>

        <div class="input-group">
            <label>Schools</label>
            <div id="schoolsTags" class="tag-display-area"></div>
            <div class="input-slot">
                <input type="text" id="schoolsInput" placeholder="Add School...">
                <button type="button" onclick="addTag('schools')">ADD</button>
            </div>
        </div>

        <div class="input-group">
            <label>Clubs</label>
            <div id="clubsTags" class="tag-display-area"></div>
            <div class="input-slot">
                <input type="text" id="clubsInput" placeholder="Add Club...">
                <button type="button" onclick="addTag('clubs')">ADD</button>
            </div>
        </div>

        <div class="input-group">
            <label>Keywords</label>
            <div id="general_keywordsTags" class="tag-display-area"></div>
            <div class="input-slot">
                <input type="text" id="general_keywordsInput" placeholder="Add Keyword...">
                <button type="button" onclick="addTag('general_keywords')">ADD</button>
            </div>
        </div>

        <div class="input-group">
            <label>Noise Filter</label>
            <div id="exclude_keywordsTags" class="tag-display-area"></div>
            <div class="input-slot">
                <input type="text" id="exclude_keywordsInput" placeholder="Exclude...">
                <button type="button" onclick="addTag('exclude_keywords')">ADD</button>
            </div>
        </div>

        <!-- Stacked Tray Mapper -->
        <div class="mapper-section">
            <span class="mapper-label">Visual Label Mapper</span>
            
            <div class="chip-pool" id="keywordPool">
                <!-- Keywords Cloud -->
            </div>

            <div id="childBuckets">
                <!-- Drawer Buckets -->
            </div>
        </div>

        <div class="bottom-actions">
            <div id="saveStatus"></div>
            <button type="button" class="save-btn" onclick="saveSettings()">Save Slate</button>
            <div class="sync-pulse" onclick="triggerSync()" id="syncBtn">Manual Pulse Sync</div>
        </div>
    </form>
</div>

<script>
    let currentMappings = {};
    let categoryData = {};

    function updateMapperPool() {
        const ids = ['children', 'year_groups', 'schools', 'clubs', 'general_keywords'];
        let allKeywords = [];
        ids.forEach(id => { allKeywords = allKeywords.concat(categoryData[id] || []); });

        const mapCounts = {};
        Object.values(currentMappings).forEach(keywords => {
            keywords.forEach(k => { mapCounts[k] = (mapCounts[k] || 0) + 1; });
        });

        const poolContainer = document.getElementById('keywordPool');
        poolContainer.innerHTML = '';
        const uniqueKeywords = [...new Set(allKeywords)];

        uniqueKeywords.forEach(keyword => {
            const isGhost = (mapCounts[keyword] || 0) > 0;
            
            const el = document.createElement('div');
            el.className = `chip ${isGhost ? 'ghost' : ''}`;
            el.innerHTML = `
                <span>${keyword}</span>
                <span class="delete-btn" onclick="event.stopPropagation(); deleteKeywordFromSource('${keyword.replace(/'/g, "\\'")}')">×</span>
            `;
            el.draggable = true;
            
            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', keyword);
                el.classList.add('dragging');
                document.querySelectorAll('.bucket-drawer').forEach(b => b.classList.add('ready-to-drop'));
            });
            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
                document.querySelectorAll('.bucket-drawer').forEach(b => b.classList.remove('ready-to-drop'));
            });
            poolContainer.appendChild(el);
        });
    }

    function deleteKeywordFromSource(keyword) {
        if (!confirm(`Purge "${keyword}"?`)) return;
        ['children', 'year_groups', 'schools', 'clubs', 'general_keywords'].forEach(id => {
            if (categoryData[id]) {
                categoryData[id] = categoryData[id].filter(k => k !== keyword);
                renderCategoryTags(id);
            }
        });
        Object.keys(currentMappings).forEach(label => {
            currentMappings[label] = currentMappings[label].filter(k => k !== keyword);
        });
        updateMapperPool();
        renderBuckets(categoryData['children'] || []);
    }

    function renderCategoryTags(category) {
        const container = document.getElementById(category + 'Tags');
        if (!container) return;
        container.innerHTML = '';
        const items = categoryData[category] || [];
        const isDanger = category === 'exclude_keywords';

        items.forEach(value => {
            const tag = document.createElement('div');
            tag.className = `category-tag ${isDanger ? 'danger' : ''}`;
            tag.innerHTML = `
                <span>${value}</span>
                <span class="delete-btn" style="font-size:0.8rem; margin-left:5px" onclick="removeCategoryTag('${category}', '${value.replace(/'/g, "\\'")}')">×</span>
            `;
            container.appendChild(tag);
        });
        updateMapperPool();
        if (category === 'children') renderBuckets(items);
    }

    function addTag(category) {
        const input = document.getElementById(category + 'Input');
        const val = input.value.trim();
        if (!val) return;
        if (!categoryData[category]) categoryData[category] = [];
        if (!categoryData[category].includes(val)) {
            categoryData[category].push(val);
            input.value = '';
            renderCategoryTags(category);
        }
    }

    function removeCategoryTag(category, value) {
        categoryData[category] = categoryData[category].filter(v => v !== value);
        Object.keys(currentMappings).forEach(l => currentMappings[l] = currentMappings[l].filter(k => k !== value));
        renderCategoryTags(category);
    }

    function renderBuckets(labels) {
        const container = document.getElementById('childBuckets');
        container.innerHTML = '';
        labels.forEach(fullName => {
            const firstName = fullName.split(' ')[0];
            const div = document.createElement('div');
            div.className = 'bucket-drawer';
            div.innerHTML = `
                <h4>${firstName}</h4>
                <div class="bucket-tags"></div>
            `;
            const tagArea = div.querySelector('.bucket-tags');
            const items = currentMappings[firstName] || [];
            items.forEach(kw => {
                const tag = document.createElement('div');
                tag.className = 'assigned-chip';
                tag.innerHTML = `${kw} <span class="remove-id" onclick="removeMapping('${firstName}', '${kw}')">×</span>`;
                tagArea.appendChild(tag);
            });
            div.addEventListener('dragover', (e) => { e.preventDefault(); div.classList.add('drag-over'); });
            div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
            div.addEventListener('drop', (e) => {
                e.preventDefault();
                div.classList.remove('drag-over');
                const kw = e.dataTransfer.getData('text/plain');
                if (kw) addMapping(firstName, kw);
            });
            container.appendChild(div);
        });
    }

    function addMapping(label, keyword) {
        if (!currentMappings[label]) currentMappings[label] = [];
        if (!currentMappings[label].includes(keyword)) {
            currentMappings[label].push(keyword);
            updateMapperPool();
            renderBuckets(categoryData['children'] || []);
        }
    }

    function removeMapping(label, keyword) {
        currentMappings[label] = currentMappings[label].filter(k => k !== keyword);
        updateMapperPool();
        renderBuckets(categoryData['children'] || []);
    }

    async function loadData() {
        try {
            const r = await fetch('/api/settings');
            const d = await r.json();
            const config = d.config;
            categoryData = {
                children: config.search_settings.children || [],
                year_groups: config.search_settings.year_groups || [],
                schools: config.search_settings.schools || [],
                clubs: config.search_settings.clubs || [],
                general_keywords: config.search_settings.general_keywords || [],
                exclude_keywords: config.filtering_logic.exclude_keywords || [],
                strict_override_keywords: config.filtering_logic.strict_override_keywords || []
            };
            currentMappings = config.child_mappings || {};
            Object.keys(categoryData).forEach(cat => {
                renderCategoryTags(cat);
                document.getElementById(cat + 'Input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); addTag(cat); }
                });
            });
        } catch (e) { console.error(e); }
    }

    async function saveSettings() {
        const body = JSON.stringify({
            search_settings: {
                children: categoryData.children,
                year_groups: categoryData.year_groups,
                schools: categoryData.schools,
                clubs: categoryData.clubs,
                general_keywords: categoryData.general_keywords
            },
            filtering_logic: {
                exclude_keywords: categoryData.exclude_keywords,
                strict_override_keywords: categoryData.strict_override_keywords
            },
            child_mappings: currentMappings
        });
        try {
            const r = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body
            });
            if (r.ok) {
                const s = document.getElementById('saveStatus');
                s.innerText = 'SLATE SYNCHRONIZED';
                setTimeout(() => s.innerText = '', 3000);
            }
        } catch (e) { console.error(e); }
    }

    async function triggerSync() {
        const b = document.getElementById('syncBtn');
        b.innerText = "PULSING...";
        try {
            const r = await fetch('/api/trigger', { method: 'POST' });
            if (r.ok) b.innerText = "PULSE TRANSMITTED";
            setTimeout(() => b.innerText = "Manual Pulse Sync", 3000);
        } catch (e) { b.innerText = "ERROR"; }
    }

    loadData();
</script>
</body>
</html>
